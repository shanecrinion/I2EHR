---
title: "CVD_DEA"
author: "Shane Crinion"
date: "3 July 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
#General Bioconductor packages
    library(Biobase)
    library(oligoClasses)
     
#Annotation and data import packages
    library(ArrayExpress)
    library(pd.hugene.1.0.st.v1)
 #   library(hugene10sttranscriptcluster.db)
    library(hgu133a2.db)
     
#Quality control and pre-processing packages
    library(oligo)
    library(arrayQualityMetrics)
     
#Analysis and statistics packages
    library(limma)
    library(topGO)
    library(ReactomePA)
    library(clusterProfiler)
     
#Plotting and color options packages
    library(gplots)
    library(ggplot2)
    library(geneplotter)
    library(RColorBrewer)
    library(pheatmap)
     
#Formatting/documentation packages
   #library(rmarkdown)
   #library(BiocStyle)
    library(dplyr)
    library(tidyr)
#    library(magick)

#Helpers:
    library(stringr)
    library(matrixStats)
    library(genefilter)
    library(openxlsx)
   #library(devtools)
```

CVD sample 

```{r}
library(GEOquery)
genomic_data <- getGEO("GSE46097", GSEMatrix = TRUE)
```


```{r}

#import all csv files containing clinical data from Synthea
setwd("/media/shane/Data/github/I2EHR/I2EHR_APP/")
temp = list.files(pattern="*.csv")
for (i in 1:length(temp)) assign(temp[i], read.csv(temp[i]))
message("Finished: Importing clinical data")
message("Set up complete")


```

```{r}
head(patients.csv)
```


```{r}
sort(patients.csv$GENDER)
library(plyr)
plyr::count(patients.csv$GENDER)
patient_id_list <- rep(patients.csv$PATIENT, each=3)

```



```{r}
library(stringr)
pData(genomic_data[[1]])$title <- as.character(pData(genomic_data[[1]])$title)

x <- replace(pData(genomic_data[[1]])$title, str_detect(Biobase::pData(genomic_data[[1]])$title, 
                                                        "baseline"), "baseline")
x <- replace(pData(genomic_data[[1]])$title, str_detect(Biobase::pData(genomic_data[[1]])$title, 
                                                        "3month"), "month3")
x <- replace(x, str_detect(Biobase::pData(genomic_data[[1]])$title, 
                           "baseline"), "baseline")
x <- replace(x, str_detect(Biobase::pData(genomic_data[[1]])$title, 
                           "1year"), "year1")

# correcting mistakes in the published data
x <- replace(x, str_detect(Biobase::pData(genomic_data[[1]])$title, 
                           "basleline"), "baseline")
x <- replace(x, str_detect(Biobase::pData(genomic_data[[1]])$title, 
                           "3moths"), "month3")
x <- replace(x, str_detect(Biobase::pData(genomic_data[[1]])$title, 
                           "1_year"), "year1")
x <- replace(x, str_detect(Biobase::pData(genomic_data[[1]])$title, 
                           "1 year"), "year1")


Biobase::pData(genomic_data[[1]])$title <- x
Biobase::pData(genomic_data[[1]])$title <- as.factor(Biobase::pData(genomic_data[[1]])$title)

```


```{r}
with(pData(genomic_data[[1]]) , pData(genomic_data[[1]])[order(`gender:ch1`),]) 
pData(genomic_data[[1]]) <- with(pData(genomic_data[[1]]), pData(genomic_data[[1]])[order(`gender:ch1`),]) 

# the below assigns a patient ID of someone of the same sex
genomic_data[[1]]$PATIENT <- NULL
genomic_data[[1]]$PATIENT <- rep(patients.csv$PATIENT, each=3)
```


```{r}

```



Set up the additional values for integration

```{r}
library(GOexpress)

###### SET UP FOR PCA

sub.genomic_data.control <- subEset(
  eSet=genomic_data[[1]],
  subset=list(
    `group:ch1` =c("Matched Ornish Participant")))
control_patient <- sub.genomic_data.control$PATIENT 

sub.genomic_data.case <- subEset(
  eSet=genomic_data[[1]],
  subset=list(
    `group:ch1` =c("Matched Control Group")))

case_patient <- sub.genomic_data.case$PATIENT

'%!in%' <- function(x,y)!('%in%'(x,y))

observations.csv$`group:ch1` <- 0
observations.csv[observations.csv$PATIENT %in% case_patient,]$`group:ch1` <- "Matched Control Group"
observations.csv[observations.csv$PATIENT %in% control_patient,]$`group:ch1` <- "Matched Ornish Participant" 

observations.csv$PCA_sim_BMI <- 0
observations.csv[observations.csv$DESCRIPTION == "Body Mass Index" 
                 & observations.csv$`group:ch1` == "Matched Control Group",]$PCA_sim_BMI <- rnorm(1941, mean=23)

observations.csv[observations.csv$DESCRIPTION == "Body Mass Index" 
                 & observations.csv$`group:ch1` == "Matched Ornish Participant",]$PCA_sim_BMI <- rnorm(1788, mean = 29)

obs_bmi_overweight <- subset(x=observations.csv, DESCRIPTION == "Body Mass Index" & PCA_sim_BMI >= 25)
obs_bmi_healthy <- subset(x=observations.csv, DESCRIPTION == "Body Mass Index" & PCA_sim_BMI < 25)


genomic_data[[1]]$`ch1:highBMI_stat` <- NA
genomic_data[[1]]$`ch1:highBMI_stat`[genomic_data[[1]]$PATIENT %in% obs_bmi_overweight$PATIENT] <- "Overweight"
genomic_data[[1]]$`ch1:highBMI_stat`[genomic_data[[1]]$PATIENT %in% obs_bmi_healthy$PATIENT] <- "Healthy"


observations.csv$PCA_sim_SBP <- 0
observations.csv[observations.csv$DESCRIPTION == "Systolic Blood Pressure" 
                 & observations.csv$`group:ch1` == "Matched Control Group",]$PCA_sim_SBP <- rnorm(2504, mean=117)

observations.csv[observations.csv$DESCRIPTION == "Systolic Blood Pressure" 
                 & observations.csv$`group:ch1` == "Matched Ornish Participant",]$PCA_sim_SBP <- rnorm(2355, mean = 123)


obs_sbp_high_bp <- subset(x=observations.csv, DESCRIPTION == "Systolic Blood Pressure" & PCA_sim_SBP >= 120)
obs_sbp_healthy <- subset(x=observations.csv, DESCRIPTION == "Systolic Blood Pressure" & PCA_sim_SBP < 120)


genomic_data[[1]]$`ch1:SBP` <- NA
genomic_data[[1]]$`ch1:SBP`[genomic_data[[1]]$PATIENT %in% obs_sbp_high_bp$PATIENT] <- "High Systolic"
genomic_data[[1]]$`ch1:SBP`[genomic_data[[1]]$PATIENT %in% obs_sbp_healthy$PATIENT] <- "Healthy"


observations.csv$PCA_sim_DBP <- 0
observations.csv[observations.csv$DESCRIPTION == "Diastolic Blood Pressure" 
                 & observations.csv$`group:ch1` == "Matched Control Group",]$PCA_sim_DBP <- rnorm(2504, mean=73)

observations.csv[observations.csv$DESCRIPTION == "Diastolic Blood Pressure" 
                 & observations.csv$`group:ch1` == "Matched Ornish Participant",]$PCA_sim_DBP <- rnorm(2355, mean = 84)


obs_dbp_high_bp <- subset(x=observations.csv, DESCRIPTION == "Diastolic Blood Pressure" & PCA_sim_DBP < 80)
obs_dbp_healthy <- subset(x=observations.csv, DESCRIPTION == "Diastolic Blood Pressure" & PCA_sim_DBP >= 80)


genomic_data[[1]]$`ch1:DBP` <- NA
genomic_data[[1]]$`ch1:DBP`[genomic_data[[1]]$PATIENT %in% obs_dbp_high_bp$PATIENT] <- "High Diastolic"
genomic_data[[1]]$`ch1:DBP`[genomic_data[[1]]$PATIENT %in% obs_dbp_healthy$PATIENT] <- "Healthy"

######### plot difference




BMI.genomic_data.control <- subEset(
  eSet=genomic_data[[1]],
  subset=list(
    `ch1:highBMI_stat` =c("Overweight")))


BMI.genomic_data.case <- subEset(
  eSet=genomic_data[[1]],
  subset=list(
    `ch1:highBMI_stat` =c("Healthy")))




exprs(BMI.genomic_data.control)
exprs(BMI.genomic_data.case) 


exprs_class <- factor(c("case", "control")) 
case <- rep(exprs_class[1], length(exprs(BMI.genomic_data.case)))
control <- rep(exprs_class[2], length(exprs(BMI.genomic_data.control)))

```



```{r}

#paste the full name for search feature
#patients.csv$FULLNAME <- paste(patients.csv$FIRST,  patients.csv$LAST)
genomic_data[[1]]$FULLNAME <- rep(patients.csv$FULLNAME, each = 3)

```

```{r}

pData(genomic_data[[1]]) <- pData(genomic_data[[1]])[, c("FULLNAME",
                                                         "geo_accession",
                                                         "PATIENT", 
                                                         "age:ch1",
                                                         "title",
                                                         "group:ch1",
                                                         "cad:ch1",
                                                         "diabetes:ch1",
                                                         "gender:ch1",
                                                         "ch1:highBMI_stat",
                                                         "ch1:DBP",
                                                         "ch1:SBP")]
```




```{r}

exp_data <- Biobase::exprs(genomic_data[[1]])
PCA_raw <- prcomp(t(exp_data), scale. = TRUE)
percentVar <- round(100*PCA_raw$sdev^2/sum(PCA_raw$sdev^2),1)
sd_ratio <- sqrt(percentVar[2] / percentVar[1])


##filtering following inspection of intensity
man_threshold <- 9
no_of_samples <- 
  table(paste0(pData(genomic_data[[1]])$`group:ch1`, "_", 
               pData(genomic_data[[1]])$`diabetes:ch1`))

samples_cutoff <- min(no_of_samples)
idx_man_threshold <- apply(exp_data, 1,
                           function(x){
                             sum(x > man_threshold) >= samples_cutoff})
Ellsworth_medians <- rowMedians(exp_data)

Ellsworth_manfiltered <- subset(genomic_data[[1]], idx_man_threshold)
anno_Ellsworth <- AnnotationDbi::select(hgu133a2.db,
                                        keys = (featureNames(Ellsworth_manfiltered)),
                                        columns = c("SYMBOL", "GENENAME"),
                                        keytype = "PROBEID")


anno_Ellsworth
```


Consisting of ...

```{r}
summary(Biobase::pData(CVD_Samples[[1]]))
```


- 378 samples
- 3 samples for each person
- 63 patients and 63 control
- About 20 in total have diabetes


Quality control


```{r}
Biobase::exprs(genomic_data[[1]])[1:5, 1:5]
#CVD_Samples[[1]]$Individual <-  rep(1:126,each=3)
#CVD_Control_SampleID <- sampleNames(CVD_Samples[[1]])[193:378]
#CVD_Case_SampleID <- sampleNames(CVD_Samples[[1]])[0:192]
#CVD_Cases = CVD_Samples[[1]][, CVD_Case_SampleID]
#CVD_Controls = CVD_Samples[[1]][, CVD_Control_SampleID]

# confirmation that samples are coordinated
tail(CVD_Case_SampleID)
head(CVD_Control_SampleID)


```


```{r}

#genomic_data <- CVD_Samples
exp_data <- Biobase::exprs(genomic_data[[1]])
PCA_raw <- prcomp(t(exp_data), scale. = TRUE)

percentVar <- round(100*PCA_raw$sdev^2/sum(PCA_raw$sdev^2),1)
sd_ratio <- sqrt(percentVar[2] / percentVar[1])

dataGG <- data.frame(PC1 = PCA_raw$x[,1], PC2 = PCA_raw$x[,2],
                    Disease = pData(genomic_data[[1]])$`group:ch1`,
                    Phenotype = pData(genomic_data[[1]])$`diabetes:ch1`,
                    Individual = pData(genomic_data[[1]])$FULLNAME)

library(ggplot2)
ggplot(dataGG, aes(PC1, PC2)) +
      geom_point(aes(shape = Disease, colour = Phenotype)) +
  ggtitle("PCA plot of the log-transformed raw expression data") +
  xlab(paste0("PC1, VarExp: ", percentVar[1], "%")) +
  ylab(paste0("PC2, VarExp: ", percentVar[2], "%")) +
  theme(plot.title = element_text(hjust = 0.5))+
  coord_fixed(ratio = sd_ratio) +
  scale_shape_manual(values = c(4,15)) + 
  scale_color_manual(values = c("darkorange2", "dodgerblue4"))

```

```{r}
  

oligo::boxplot(genomic_data[[1]], target = "core", 
               main = "Boxplot of log2-intensitites for the raw data", 
               las=2)


```

```{r}
library(arrayQualityMetrics)
arrayQualityMetrics(expressionset = CVD_Samples[[1]],
    outdir = tempdir(),
    force = TRUE, do.logtransform = TRUE,
    intgroup = c("group:ch1"))
```

```{r}
# 

distance_between_arrays <- image_read_svg('http://jeroen.github.io/images/tiger.svg', width = 400)
print(distance_between_arrays)


```

```{r}

outlier_distance_between_arrays <- image_read_svg('', width = 400)
print(outlier_distance_between_arrays)
```

```{r}

PCA_report <- image_read_svg('http://jeroen.github.io/images/tiger.svg', width = 400)
print(PCA_report)
```


```{r}

array_intensity_boxplot <- image_read_svg('http://jeroen.github.io/images/tiger.svg', width = 400)
print(array_intensity_boxplot)
```

```{r}

density_plot <- image_read_svg('http://jeroen.github.io/images/tiger.svg', width = 400)
print(density_plot)
```

```{r}

stddev_vs_mean <- image_read_svg('http://jeroen.github.io/images/tiger.svg', width = 400)
print(stddev_vs_mean)
```


```{r}

MA_plot_outlier <- image_read_svg('http://jeroen.github.io/images/tiger.svg', width = 400)
print(MA_plot)
```

```{r}
MA_plot <- image_read_svg('http://jeroen.github.io/images/tiger.svg', width = 400)
print(MA_plot_outlier)
```


## Background adjustment

```{r}
library(hgu133a2.db)
head(ls("package:hgu133a2.db"))
```

RLE

```{r}

# not necessary as the values are normalised
#Ellsworth_eset <- oligo::rma(CVD_Samples[[1]], target = "core", normalize = FALSE)
Ellsworth_eset <- genomic_data[[1]]
```

```{r}

exp_data <- Biobase::exprs(genomic_data[[1]])
row_medians_assayData <- 
  Biobase::rowMedians(as.matrix(exp_data))

RLE_data <- sweep(Biobase::exprs(genomic_data[[1]]), 1, row_medians_assayData)

RLE_data <- as.data.frame(RLE_data)
RLE_data_gathered <- 
  tidyr::gather(RLE_data, patient_array, log2_expression_deviation)

ggplot2::ggplot(RLE_data_gathered, aes(patient_array,
                                       log2_expression_deviation)) + 
  geom_boxplot(outlier.shape = NA) + 
  ylim(c(-2, 2)) + 
  theme(axis.text.x = element_text(colour = "aquamarine4", 
                                  angle = 60, size = 6.5, hjust = 1 ,
                                  face = "bold"))

```

```{r}
View(RLE_data)

head(RLE_data_gathered)

```


```{r}

  ######## PATIENT 
  subset.patient <- subEset(
    eSet=genomic_data[[1]],
    subset=list(
      PATIENT=c("0cd0592a-774a-4ece-806a-5384a15af9b4")))
  ###### END PATIENT

  #genomic_data_selection <- genomic_data[[1]][,genomic_data[[1]]$PATIENT == input$search]

subset.patient.RLE_data <- 
  data.frame(patient_array = rownames(pData(subset.patient)), 
                                  disease_cat = Biobase::pData(subset.patient)$`diabetes:ch1`)








RLE_data_patient <- as.data.frame(subset.patient.RLE_data)

 ## DATA
  row_medians_assayData_patient <- 
    Biobase::rowMedians(as.matrix(exprs(subset.patient)))
  
  RLE_data_patient <- sweep(log2(Biobase::exprs(subset.patient)), 1, 
                            row_medians_assayData_patient)
  # class for the fill
  RLE_class_patient <- data.frame(patient_array = rownames(pData(subset.patient)), 
                                  disease_cat = Biobase::pData(subset.patient)$`diabetes:ch1`)
  
  RLE_data_patient <- as.data.frame(RLE_data_patient)
  RLE_data_gathered_patient <- 
    tidyr::gather(RLE_data_patient, 
                  patient_array, 
                  log2_expression_deviation)
  
  RLE_data_gathered_diagnosis_patient <- 
    merge(RLE_data_gathered_patient, 
          RLE_class_patient, 
          by="patient_array")
  
  ###### CONTROL file set up
  
  diabetes_state <- subset.patient$`diabetes:ch1`[1]
  gender_state <- subset.patient$`gender:ch1`[1]
  cad_state <- subset.patient$`cad:ch1`[1]
  age_range <- c((as.numeric(subset.patient$`age:ch1`) - 5 ),
                 (as.numeric(subset.patient$`age:ch1`) + 5 ))
  age_range <- age_range[c(1,5)]

  
  subset.control <- genomic_data[[1]][,genomic_data[[1]]$`diabetes:ch1` == diabetes_state]
  subset.control <- subset.control[,subset.control$`gender:ch1` == gender_state]
  subset.control <- subset.control[,subset.control$`cad:ch1` == cad_state]
  subset.control <- subset.control[,subset.control$`age:ch1` > age_range[1] 
                                   & subset.control$`age:ch1` < age_range[2]]
  subset.control <- subset.control[,subset.control$`cad:ch1` == cad_state]
  subset.control <- subset.control[,subset.control$`group:ch1` != "Matched Ornish Participant"]
  subset.control <- subset.control[1]
  
```





RLE for the patient


```{r}

######## PATIENT 
  subset.patient <- subEset(
    eSet=genomic_data[[1]],
    subset=list(
      PATIENT=c("0cd0592a-774a-4ece-806a-5384a15af9b4")))
  ###### END PATIENT

  
subset.patient.RLE <-
 RLE_data[sampleNames(subset.patient)]

# medians 
subset.patient.row_medians_assayData <- 
  Biobase::rowMedians(as.matrix(subset.patient.RLE))

# sweep
subset.patient.RLE_data <- sweep(subset.patient.RLE, 1, 
                            subset.patient.row_medians_assayData)

# as dataframe
subset.patient.RLE_data <- as.data.frame(subset.patient.RLE_data)

# gathered
subset.patient.RLE_data_gathered <- 
  tidyr::gather(subset.patient.RLE_data, patient_array, log2_expression_deviation)


ggplot2::ggplot(subset.patient.RLE_data_gathered, aes(patient_array,log2_expression_deviation)) + 
  geom_boxplot(outlier.shape = NA) + 
  ylim(c(-1, 1)) + 
  theme(axis.text.x = element_text(colour = "aquamarine4", 
                                  angle = 60, size = 6.5, hjust = 1 ,
                                  face = "bold"))

  
  
```



Creating a control

```{r}

######## PATIENT 
  subset.patient <- subEset(
    eSet=genomic_data[[1]],
    subset=list(
      PATIENT=c(input$search)))
  ###### END PATIENT


  diabetes_state <- subset.patient$`diabetes:ch1`[1]
  gender_state <- subset.patient$`gender:ch1`[1]
  cad_state <- subset.patient$`cad:ch1`[1]
  age_range <- c((as.numeric(subset.patient$`age:ch1`) - 5 ),
                 (as.numeric(subset.patient$`age:ch1`) + 5 ))
  age_range <- age_range[c(1,5)]

  
  subset.control <- genomic_data[[1]][,genomic_data[[1]]$`diabetes:ch1` == diabetes_state]
  subset.control <- subset.control[,subset.control$`gender:ch1` == gender_state]
  subset.control <- subset.control[,subset.control$`cad:ch1` == cad_state]
  subset.control <- subset.control[,subset.control$`age:ch1` > age_range[1] 
                                   & subset.control$`age:ch1` < age_range[2]]
  subset.control <- subset.control[,subset.control$`cad:ch1` == cad_state]
  subset.control <- subset.control[,subset.control$`group:ch1` != "Matched Ornish Participant"]
  subset.control <- subset.control[1]
  subset.control.samples <- sampleNames(subset.control)[1:3]
  
```


RLE for the control

```{r}

subset.control.RLE <-
 RLE_data[subset.control.samples]

# medians 
subset.control.row_medians_assayData <- 
  Biobase::rowMedians(as.matrix(subset.control.RLE))

# sweep
subset.control.RLE_data <- sweep(subset.control.RLE, 1, 
                            subset.control.row_medians_assayData)

# as dataframe
subset.control.RLE_data <- as.data.frame(subset.control.RLE_data)

# gathered
subset.control.RLE_data_gathered <- 
  tidyr::gather(subset.control.RLE_data, patient_array, log2_expression_deviation)


ggplot2::ggplot(subset.control.RLE_data_gathered, aes(patient_array,log2_expression_deviation)) + 
  geom_boxplot(outlier.shape = NA) + 
  ylim(c(-1, 1)) + 
  theme(axis.text.x = element_text(colour = "aquamarine4", 
                                  angle = 60, size = 6.5, hjust = 1 ,
                                  face = "bold"))

```





RMA cal

```{r}
#Ellsworth_eset_norm <- oligo::rma(CVD_Samples, target = "core")
Ellsworth_eset_norm <- Ellsworth_eset
```

```{r}
exp_Ellsworth <- Biobase::exprs(Ellsworth_eset_norm)
PCA <- prcomp(t(exp_Ellsworth), scale = FALSE)

percentVar <- round(100*PCA$sdev^2/sum(PCA$sdev^2),1)
sd_ratio <- sqrt(percentVar[2] / percentVar[1])

dataGG <- data.frame(PC1 = PCA$x[,1], PC2 = PCA$x[,2],
                    Disease = 
                     Biobase::pData(Ellsworth_eset_norm)$`group:ch1`,
                    Phenotype = 
                     Biobase::pData(Ellsworth_eset_norm)$`diabetes:ch1`) # change this to input select


ggplot(dataGG, aes(PC1, PC2)) +
      geom_point(aes(shape = Disease, colour = Phenotype)) +
  ggtitle("PCA plot of the calibrated, summarized data") +
  xlab(paste0("PC1, VarExp: ", percentVar[1], "%")) +
  ylab(paste0("PC2, VarExp: ", percentVar[2], "%")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  coord_fixed(ratio = sd_ratio) +
  scale_shape_manual(values = c(4,15)) + 
  scale_color_manual(values = c("darkorange2", "dodgerblue4"))
```

```{r}
phenotype_names <- ifelse(str_detect(pData
                                    (genomic_data[[1]])$`diabetes:ch1`,"No"), "non_diabetic", "diabetic")

disease_names <- ifelse(str_detect(pData
                                    (genomic_data[[1]])$`group:ch1`,
                             "Matched Ornish"), "case", "control")

annotation_for_heatmap <- 
  data.frame(Phenotype = phenotype_names,  Disease = disease_names)

row.names(annotation_for_heatmap) <- row.names(pData(genomic_data[[1]]))
```

```{r}
dists <- as.matrix(dist(t(exprs(genomic_data[[1]])), method = "manhattan"))


rownames(dists) <- row.names(pData(genomic_data[[1]]))
hmcol <- rev(colorRampPalette(RColorBrewer::brewer.pal(9, "YlOrRd"))(255))
colnames(dists) <- NULL
diag(dists) <- NA

ann_colors <- list(
  Phenotype = c(non_diabetic = "chartreuse4", diabetic = "burlywood3"),
  Disease = c(case = "blue4", control = "cadetblue2")
                   )

#### add the diabetes sidebar
library(d3heatmap)
d3heatmap(dists, color = (hmcol), 
         annotation_row = annotation_for_heatmap,
         annotation_colors = ann_colors,
         legend = TRUE, 
         treeheight_row = 0,
         legend_breaks = c(min(dists, na.rm = TRUE), 
                         max(dists, na.rm = TRUE)), 
         legend_labels = (c("small distance", "large distance")),
         main = "Clustering heatmap for the calibrated samples")
```


Filtering based on intensity


```{r}
Ellsworth_medians <- rowMedians(Biobase::exprs(genomic_data[[1]]))

hist_res <- hist(Ellsworth_medians, 100, col = "cornsilk1", freq = FALSE, 
            main = "Histogram of the median intensities", 
            border = "antiquewhite4",
            xlab = "Median intensities")
```

```{r}

## make the threshold a slider input
man_threshold <- 12

hist_res <- hist(Ellsworth_medians, 100, col = "cornsilk", freq = FALSE, 
            main = "Histogram of the median intensities",
            border = "antiquewhite4",
            xlab = "Median intensities")

abline(v = man_threshold, col = "coral4", lwd = 2)

```

```{r}
no_of_samples <- 
  table(paste0(pData(genomic_data[[1]])$`group:ch1`, "_", 
                  pData(genomic_data[[1]])$`diabetes:ch1`))
no_of_samples 
```

```{r}
samples_cutoff <- min(no_of_samples)

idx_man_threshold <- apply(Biobase::exprs(genomic_data[[1]]), 1,
                           function(x){
                          sum(x > man_threshold) >= samples_cutoff})
                          table(idx_man_threshold)
```


```{r}
Ellsworth_manfiltered <- subset(genomic_data[[1]], idx_man_threshold)
```

Annotation

```{r}

anno_Ellsworth <- AnnotationDbi::select(hgu133a2.db,
                                  keys = (featureNames(Ellsworth_manfiltered)),
                                  columns = c("SYMBOL", "GENENAME"),
                                  keytype = "PROBEID")

anno_Ellsworth <- subset(anno_Ellsworth, !is.na(SYMBOL))

```

Removing muktiple mappings



```{r}
anno_grouped <- group_by(anno_Ellsworth, PROBEID)
anno_summarized <- 
  dplyr::summarize(anno_grouped, no_of_matches = n_distinct(SYMBOL))

head(anno_summarized)

```

```{r}
anno_filtered <- filter(anno_summarized, no_of_matches > 1)

head(anno_filtered)
```

```{r}
probe_stats <- anno_filtered 

nrow(probe_stats)
```

```{r}
ids_to_exlude <- (featureNames(Ellsworth_manfiltered) %in% probe_stats$PROBEID)

table(ids_to_exlude)
```

```{r}
Ellsworth_final <- subset(Ellsworth_manfiltered, !ids_to_exlude)

validObject(Ellsworth_final)
```

```{r}
head(anno_Ellsworth)
```

```{r}
fData(Ellsworth_final)$PROBEID <- rownames(fData(Ellsworth_final))
```

```{r}
fData(Ellsworth_final) <- left_join(fData(Ellsworth_final), anno_Ellsworth)
```

```{r}
# restore rownames after left_join
rownames(fData(Ellsworth_final)) <- fData(Ellsworth_final)$PROBEID 
    
validObject(Ellsworth_final)
```


Linear models

```{r}


###########

pData(Ellsworth_final)$title <- as.character(pData(Ellsworth_final)$title)
x <- replace(pData(Ellsworth_final)$title, str_detect(Biobase::pData(Ellsworth_final)$title, 
                    "baseline"), "baseline")

x <- replace(pData(Ellsworth_final)$title, str_detect(Biobase::pData(Ellsworth_final)$title, 
                    "3month"), "month3")

x <- replace(x, str_detect(Biobase::pData(Ellsworth_final)$title, 
                    "baseline"), "baseline")


x <- replace(x, str_detect(Biobase::pData(Ellsworth_final)$title, 
                    "1year"), "year1")


####### correcting mistakes in the published data
x <- replace(x, str_detect(Biobase::pData(Ellsworth_final)$title, 
                    "basleline"), "baseline")


x <- replace(x, str_detect(Biobase::pData(Ellsworth_final)$title, 
                    "3moths"), "month3")

x <- replace(x, str_detect(Biobase::pData(Ellsworth_final)$title, 
                    "1_year"), "year1")

x <- replace(x, str_detect(Biobase::pData(Ellsworth_final)$title, 
                    "1 year"), "year1")

Biobase::pData(Ellsworth_final)$title <- x
Biobase::pData(Ellsworth_final)$title <- as.factor(Biobase::pData(Ellsworth_final)$title)
```


Now to do with the limited values to contain only baseline and 1 year, the 2 most contrasting setss


```{r}
## set up the subset
# Subset it to only samples of "CN" and "MB" treatments, and also only "2H",
# "6H", and "24H" time-points
library(GOexpress)
sub.genomic_data.case <- subEset(
    eSet=genomic_data[[1]],
    subset=list(
        `group:ch1`=c("Matched Ornish Participant")))

library(GOexpress)
sub.genomic_data.control <- subEset(
    eSet=genomic_data[[1]],
    subset=list(
        `group:ch1`=c("Matched Control Group")))


row_medians_assayData.case <- 
  Biobase::rowMedians(as.matrix(Biobase::exprs(sub.genomic_data.case)))

RLE_data.case <- sweep(Biobase::exprs(sub.genomic_data.case), 1, row_medians_assayData.case)

RLE_data.case <- as.data.frame(RLE_data.case)
RLE_data_gathered.case <- 
  tidyr::gather(RLE_data.case, patient_array, log2_expression_deviation)

ggplot2::ggplot(RLE_data_gathered.case, aes(patient_array,
                                       log2_expression_deviation)) + 
  geom_boxplot(outlier.shape = NA) + 
  ylim(c(-2, 2)) + 
  theme(axis.text.x = element_text(colour = "aquamarine4", 
                                  angle = 60, size = 6.5, hjust = 1 ,
                                  face = "bold"))



row_medians_assayData <- 
  Biobase::rowMedians(as.matrix(Biobase::exprs(genomic_data[[1]])))

RLE_data <- sweep(Biobase::exprs(genomic_data[[1]]), 1, row_medians_assayData)

RLE_data <- as.data.frame(RLE_data)
RLE_data_gathered <- 
  tidyr::gather(RLE_data, patient_array, log2_expression_deviation)

ggplot2::ggplot(RLE_data_gathered, aes(patient_array,
                                       log2_expression_deviation)) + 
  geom_boxplot(outlier.shape = NA) + 
  ylim(c(-2, 2)) + 
  theme(axis.text.x = element_text(colour = "aquamarine4", 
                                  angle = 60, size = 6.5, hjust = 1 ,
                                  face = "bold"))








```

```{r}



tissue <- Biobase::pData(sub.genomic_data)$title
#######

individual <- str_replace_all(Biobase::pData(sub.genomic_data)$FULLNAME,
                  c("'"), "_")
individual <- str_replace_all(individual,
                  c(" "), "_")


tissue <- str_replace_all(Biobase::pData(sub.genomic_data)$title,
                  " ", "_")


# tissue <- ifelse(phenotype == "No","non_diabetic", "diabetic")

# disease <- 
#  str_replace_all(Biobase::pData(sub.Ellsworth_final)$`group:ch1`,
#                  " ", "_")


disease <- 
  ifelse(str_detect(Biobase::pData(sub.genomic_data)$`group:ch1`, 
                    "Matched Ornish"), "Case", "Control")

```


```{r}

i_case <- individual[disease == "Case"]

design_Ellsworth_Case <- model.matrix(~ 0 + tissue[disease == "Case"] + i_case)

colnames(design_Ellsworth_Case)[1:2] <- c("baseline", "year1")
rownames(design_Ellsworth_Case) <- i_case

i_control <- individual[disease == "Control"]
design_Ellsworth_Control <- model.matrix(~ 0 + tissue[disease == "Control"] + i_control )
colnames(design_Ellsworth_Control)[1:2] <- c("baseline", "year1")
rownames(design_Ellsworth_Control) <- i_control 


```

```{r}

tissue_Case <- tissue[disease == "Case"]
RPL35_expr <- Biobase::exprs(sub.genomic_data)["200002_at", disease == "Case"]
RPL35_data <- as.data.frame(RPL35_expr)
colnames(RPL35_data)[1] <- "org_value"
RPL35_data <- mutate(RPL35_data, individual = i_case, tissue_Case)
RPL35_data$tissue_Case <- factor(RPL35_data$tissue_Case, levels = c("baseline", "year1"))

p1 <-
  ggplot(data = RPL35_data, aes(x = tissue_Case, y = org_value, 
                             group = individual, color = individual)) +
      theme(legend.position = "none") +
      geom_line() + 
      ggtitle("Expression changes for the RPL35 gene")


tissue_Control <- tissue[disease == "Control"]
RPL35_expr <- Biobase::exprs(sub.genomic_data)["200002_at", disease == "Control"]
RPL35_data <- as.data.frame(RPL35_expr)
colnames(RPL35_data)[1] <- "org_value"
RPL35_data <- mutate(RPL35_data, individual = i_control, tissue_Control)

RPL35_data$tissue_Control <- factor(RPL35_data$tissue_Control, levels = c("baseline", "year1"))

p2 <- 
  ggplot(data = RPL35_data, aes(x = tissue_Control, y = org_value, 
                             group = individual, color = individual)) +
      theme(legend.position = "none") +
      geom_line() +
      ggtitle("Expression changes for the RPL35 gene")


library(gridExtra)
grid.arrange(p1, p2, nrow = 1)

```



```{r}
RPL35_coef <- lmFit(sub.genomic_data[,disease == "Case"],
                design = design_Ellsworth_Case)$coefficients["200002_at",]
```

```{r}
RPL35_fitted <- design_Ellsworth_Case %*% RPL35_coef
rownames(RPL35_fitted) <- names(RPL35_expr)
colnames(RPL35_fitted) <- "fitted_value"
```

```{r}
RPL35_data$fitted_value <- RPL35_fitted

ggplot(data = RPL35_data, aes(x = tissue_Case, y = fitted_value, 
                             group = individual, color = individual)) +
      geom_line() +
      ggtitle("Fitted expression changes for the RPL35 gene")
 

```






```{r}

RPL35_year1 <- na.exclude(RPL35_data$org_value[tissue == "year1"])
RPL35_baseline <- na.exclude(RPL35_data$org_value[tissue == "baseline"])
res_t <- t.test(RPL35_year1 ,RPL35_baseline , paired = TRUE)
res_t
```

Contrasts and hypothesis 
```{r}


contrast_matrix_Case <- makeContrasts(baseline-year1, levels = design_Ellsworth_Case)


Ellsworth_fit_Case <- eBayes(contrasts.fit(lmFit(sub.genomic_data[,disease == "Case"],
                                design = design_Ellsworth_Case),
                                contrast_matrix_Case))

contrast_matrix_Control <- makeContrasts(baseline-year1, levels = design_Ellsworth_Control)

Ellsworth_fit_Control <- eBayes(contrasts.fit(lmFit(sub.genomic_data[,disease == "Control"],
                                design = design_Ellsworth_Control),
                                contrast_matrix_Control))

```

Extracting results

```{r}
table_Case <- topTable(Ellsworth_fit_Case, number = Inf)
head(table_Case)
```

```{r}
table_Control <- topTable(Ellsworth_fit_Control, number = Inf)
head(table_Control)
```

Multiple testingn FDR 
```{r}
nrow(subset(table_Control, P.Value < 0.05))

```

```{r}
tail(subset(table_Control, P.Value < 0.05))

```



Visualization of DE analysis results - volcano plot

```{r}

volcano_names_subset <- Ellsworth_fit_Case$coefficients[Ellsworth_fit_Case$coefficients>=1,]

volcano_names <- ifelse(abs(Ellsworth_fit_Case$coefficients) >=1 , 
                        Ellsworth_fit_Case$genes$SYMBOL, NA)
  

volcanoplot(Ellsworth_fit_Case, coef = 1L, style = "p-value", highlight = 100, 
            names = volcano_names,
            xlab = "Log2 Fold Change", ylab = NULL, pch=16, cex=0.35)



```

Gene ontology

```{r}
DE_genes_Case <- subset(table_Case, adj.P.Val < 0.1)$PROBEID
```

Matching background set of genes

```{r}
back_genes_idx <- genefilter::genefinder(sub.genomic_data, 
                                        as.character(DE_genes_Case), 
                                        method = "manhattan", scale = "none")
```

```{r}
back_genes_idx <- sapply(back_genes_idx, function(x)x$indices)
```

```{r}
back_genes <- featureNames(sub.genomic_data)[back_genes_idx]
back_genes <- setdiff(back_genes, DE_genes_Case)

    
intersect(back_genes, DE_genes_Case)
```

```{r}
length(back_genes)
```

```{r}
multidensity(list(
        all = table_Case[,"AveExpr"] ,
        fore = table_Case[DE_genes_Case , "AveExpr"],
        back = table_Case[rownames(table_Case) %in% back_genes, "AveExpr"]),
        col = c("#e46981", "#ae7ee2", "#a7ad4a"),
     xlab = "mean expression",
   main = "DE genes for Case-background-matching")

```

Running topGO

```{r}
gene_IDs <- rownames(table_Case)
in_universe <- gene_IDs %in% c(DE_genes_Case, back_genes)
in_selection <- gene_IDs %in% DE_genes_Case 

all_genes <- in_selection[in_universe]
all_genes <- factor(as.integer(in_selection[in_universe]))
names(all_genes) <- gene_IDs[in_universe] 
```

```{r}
top_GO_data <- new("topGOdata", ontology = "BP", allGenes = all_genes,
 nodeSize = 10, annot = annFUN.db, affyLib = "hgu133a2.db")
```

```{r}
result_top_GO_elim <- 
  runTest(top_GO_data, algorithm = "elim", statistic = "Fisher")
result_top_GO_classic <- 
  runTest(top_GO_data, algorithm = "classic", statistic = "Fisher")
```

```{r}
res_top_GO <- GenTable(top_GO_data, Fisher.elim = result_top_GO_elim,
        Fisher.classic = result_top_GO_classic,
        orderBy = "Fisher.elim" , topNodes = 100)

genes_top_GO <- printGenes(top_GO_data, whichTerms = res_top_GO$GO.ID,
    chip = "hgu133a2.db", geneCutOff = 1000)

res_top_GO$sig_genes <- sapply(genes_top_GO, function(x){
                str_c(paste0(x[x$'raw p-value' == 2, "Symbol.id"],";"), 
                      collapse = "")
    })

head(res_top_GO[,1:8], 20)
```

```{r}

```

```{r}
showSigOfNodes(top_GO_data, score(result_top_GO_elim), firstSigNodes = 3,
               useInfo = 'def')
```

A pathway enrichment analysis using reactome
```{r}
entrez_ids <- mapIds(hgu133a2.db, 
      keys = rownames(table_Case), 
      keytype = "PROBEID",
      column = "ENTREZID")
```

```{r}
reactome_enrich <- enrichPathway(gene = entrez_ids[DE_genes_Case], 
                                universe = entrez_ids[c(DE_genes_Case, 
                                                        back_genes)],
                                organism = "human",
                                pvalueCutoff = 0.05,
                                qvalueCutoff = 0.9, 
                                readable = TRUE)

reactome_enrich@result$Description <- paste0(str_sub(
                                    reactome_enrich@result$Description, 1, 20),
                                    "...")

head(as.data.frame(reactome_enrich))[1:6]
```

Vizualising the reactome based analysis results

```{r}
barplot(reactome_enrich)
```

```{r}
emapplot(reactome_enrich, showCategory = 10)
```



```{r}
order(pData(genomic_data[[1]]))
```


```{r}
with(pData(genomic_data[[1]]), pData(genomic_data[[1]])[order(`gender:ch1`),]) 
```

```{r}
pData(genomic_data[[1]]) <- with(pData(genomic_data[[1]]), pData(genomic_data[[1]])[order(`gender:ch1`),]) 
pData(genomic_data[[1]])
```

